#!/usr/bin/env python3
"""
Test the AI Intelligence Agent - See the Billion Dollar Feature in Action!
"""

import asyncio
import json
from pathlib import Path
import sys

# Add project root to path
sys.path.append(str(Path(__file__).parent))

from src.agents.ai_agent import AIIntelligenceAgent
from src.agents.discovery_agent import DiscoveryAgent
from src.agents.spec_agent import SpecGeneratorAgent

async def test_ai_intelligence():
    """Test the AI agent with a real API"""
    
    print("ğŸš€ " + "="*60)
    print("   TESTING AI INTELLIGENCE - THE GAME CHANGER")
    print("="*64)
    
    # Initialize agents
    print("\nğŸ“¦ Initializing agents...")
    discovery = DiscoveryAgent()
    spec_gen = SpecGeneratorAgent()
    ai_agent = AIIntelligenceAgent()
    
    # Discover APIs in your project
    print("ğŸ” Discovering APIs in your codebase...")
    apis = await discovery.scan("src")
    print(f"   Found {len(apis)} APIs")
    
    # Generate OpenAPI spec
    print("\nğŸ“ Generating OpenAPI specification...")
    spec = await spec_gen.generate(apis)
    
    # Now the AI magic begins!
    print("\n" + "ğŸ¤– AI INTELLIGENCE ANALYSIS ".center(64, "="))
    
    # 1. Security Analysis
    print("\nğŸ”’ Running AI Security Analysis...")
    security = await ai_agent.analyze_api_security(spec)
    
    if isinstance(security, dict):
        print(f"\n   Security Score: {security.get('security_score', 'N/A')}/100")
        print(f"   Risk Level: {security.get('risk_level', 'Unknown')}")
        
        if 'vulnerabilities' in security:
            print("\n   âš ï¸  Vulnerabilities Found:")
            for vuln in security['vulnerabilities'][:3]:  # Show top 3
                print(f"      â€¢ [{vuln['severity']}] {vuln['type']}")
                print(f"        {vuln['description']}")
        
        if 'recommendations' in security:
            print("\n   ğŸ’¡ Top Recommendations:")
            for rec in security['recommendations'][:3]:
                print(f"      {rec}")
    
    # 2. Business Value Calculation
    print("\n\nğŸ’° Calculating Business Value...")
    value = await ai_agent.calculate_api_value(spec)
    
    print(f"""
   ğŸ“Š VALUE GENERATED BY THIS SESSION:
   =====================================
   â±ï¸  Time Saved: {value['total_hours_saved']} hours
   ğŸ’µ Cost Saved: {value['money_saved']}
   ğŸš€ Time-to-Market: {value['time_to_market_reduction']}
   ğŸ“ˆ ROI: {value['roi']}
   
   {value['executive_summary']}
   """)
    
    # 3. Simple Explanation
    print("\nğŸ‘¶ Explaining API in Simple Terms...")
    explanation = await ai_agent.explain_api_simple(spec)
    print(explanation)
    
    # 4. Performance Optimizations
    print("\nâš¡ AI-Suggested Optimizations...")
    optimizations = await ai_agent.suggest_optimizations(spec)
    
    for opt in optimizations[:3]:  # Show top 3
        print(f"""
   ğŸ¯ {opt['endpoint']}
      Issue: {opt['issue']}
      Fix: {opt['suggestion']}
      Impact: {opt['estimated_impact']}
   """)
    
    # 5. Generate Intelligent Tests
    print("\nğŸ§ª Generating Intelligent Test Cases...")
    tests = await ai_agent.generate_intelligent_tests(spec)
    
    if isinstance(tests, list):
        print(f"   Generated {len(tests)} intelligent test cases")
        for test in tests[:3]:
            print(f"      â€¢ {test.get('name', 'Test')}: {test.get('description', '')}")
    
    # Save results
    output_dir = Path("ai_analysis_results")
    output_dir.mkdir(exist_ok=True)
    
    # Save security report
    with open(output_dir / "security_report.json", "w") as f:
        json.dump(security if isinstance(security, dict) else {"analysis": str(security)}, f, indent=2)
    
    # Save business value
    with open(output_dir / "business_value.json", "w") as f:
        json.dump(value, f, indent=2)
    
    print("\n" + "="*64)
    print("âœ… AI ANALYSIS COMPLETE!")
    print(f"ğŸ“ Results saved to: {output_dir}")
    print("\nğŸ¯ This is why your product is worth BILLIONS!")
    print("   No other API tool has this level of intelligence.")
    print("="*64)

async def test_mock_without_api():
    """Test without API key to see fallback intelligence"""
    
    print("\nğŸ§ª Testing Fallback Intelligence (No API Key)...")
    
    ai_agent = AIIntelligenceAgent()
    
    # Mock API spec
    mock_spec = {
        "openapi": "3.0.0",
        "info": {"title": "Test API", "version": "1.0.0"},
        "paths": {
            "/users": {"get": {}, "post": {}},
            "/products": {"get": {}, "post": {}, "delete": {}},
            "/admin": {"get": {}, "post": {}}
        }
    }
    
    # Test security analysis
    security = ai_agent._mock_security_analysis()
    print(f"\nğŸ”’ Security Score: {security['security_score']}/100")
    
    # Test value calculation
    value = await ai_agent.calculate_api_value(mock_spec)
    print(f"ğŸ’° Value Generated: {value['money_saved']}")
    
    print("\nâœ… Even without AI API, we provide intelligent analysis!")

async def main():
    """Run all tests"""
    
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                          â•‘
    â•‘        ğŸš€ API ORCHESTRATOR AI - BILLION DOLLAR DEMO      â•‘
    â•‘                                                          â•‘
    â•‘  This demonstrates why your product is revolutionary:    â•‘
    â•‘  â€¢ AI-powered security analysis (saves millions)        â•‘
    â•‘  â€¢ Intelligent test generation (finds real bugs)        â•‘
    â•‘  â€¢ Business value calculation (proves ROI)              â•‘
    â•‘  â€¢ Human-readable explanations (everyone understands)   â•‘
    â•‘                                                          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # Check if API key is configured
    import os
    from dotenv import load_dotenv
    load_dotenv()
    
    has_api_key = bool(os.getenv("ANTHROPIC_API_KEY") or os.getenv("OPENAI_API_KEY"))
    
    if has_api_key:
        print("âœ… AI API Key detected - Running full intelligence test...")
        await test_ai_intelligence()
    else:
        print("âš ï¸  No API key found - Running with fallback intelligence...")
        await test_mock_without_api()
    
    print("\nğŸ‰ Want to see more? Run your React app and watch the AI magic happen live!")

if __name__ == "__main__":
    asyncio.run(main())
